const v="http://www.w3.org/1999/XSL/Transform",D="http://www.w3.org/1999/xhtml",C="http://exslt.org/common",_="urn:schemas-epa-wg:dce",f=(e,l)=>e.getAttribute?.(l),S=e=>e.nodeType===3,z=(e,l="")=>(t=>(t.innerText=l||"",t))(document.createElement(e)),L=(e,l)=>(e.ownerDocument||e).createTextNode(l),$=(e,l,t="")=>(s=>(s.innerText=t||"",s))(document.createElementNS(e,l)),R=e=>(e?.setAttribute("xmlns:xsl",v),e),q=e=>(e?.setAttribute("xmlns:xhtml",D),R(e));function k(e){}function E(e){return new DOMParser().parseFromString(e,"application/xml")}function w(e){return new XMLSerializer().serializeToString(e)}function A(e,l,t,s){const n=a=>e.ownerDocument.createElement(a),p=((a,r,c)=>(r.append(c=n(a)),c))(l,e);return[...t].forEach(a=>p.append(s(a))),p}function U(e){return e.slot||(e.setAttribute||(e=z("span",e.textContent.replaceAll(`
`,""))),e.setAttribute("slot","")),e}export function Json2Xml(e,l){if(typeof e=="string")return e;const t=typeof l!="string";if(e instanceof Array)return t&&(l="array"),"<"+l+">"+e.map(function(o){return Json2Xml(o,l)}).join()+"</"+l+">";t&&(l="r"),l=l.replace(/[^a-z0-9\-]/gi,"_");var s={},n=["<"+l+" "];for(let o in e)typeof e[o]=="object"?s[o]=e[o]:n.push(o.replace(/[^a-z0-9\-]/gi,"_")+'="'+e[o].toString().replace(/&/gi,"&#38;")+'"');if(s){n.push(">");for(let o in s)n.push(Json2Xml(s[o],o));n.push("</"+l+">")}else n.push("/>");return n.join(`
`)}export function tagUid(e){if(T(e,"*",l=>[...l.childNodes].filter(t=>t.nodeType===3).forEach(t=>{if(t.parentNode.localName==="style")return;const s=t.data.matchAll(/{([^}]*)}/g);if(s){let n=0,o=a=>L(t,a||""),p=[];if([...s].forEach(a=>{a.index>n&&p.push(o(a.input.substring(n,a.index)));const r=t.ownerDocument.createElement("xsl:value-of");r.setAttribute("select",a[1]),p.push(r),n=a.index+a[0].length}),n<t.data.length&&p.push(o(t.data.substring(n,t.data.length))),p.length){for(let a of p)l.insertBefore(a,t);l.removeChild(t)}}})),"all"in e){let l=1;for(let t of e.all)t.setAttribute&&!t.tagName.startsWith("xsl:")&&t.setAttribute("data-dce-id",""+l++)}return e}export function createXsltFromDom(e,l="xsl:stylesheet"){if(e.tagName===l||e.documentElement?.tagName===l)return tagUid(e);const t=E(`<xsl:stylesheet version="1.0" xmlns:xsl="${v}" xmlns:xhtml="${D}" xmlns:exsl="${C}" exclude-result-prefixes="exsl" >   
        <xsl:output method="xml" />
        <xsl:template match="/"><dce-root><xsl:apply-templates select="*"/></dce-root></xsl:template>
        <xsl:template match="*[name()='template']"><xsl:apply-templates mode="sanitize" select="*|text()"/></xsl:template>
        <xsl:template match="*"><xsl:apply-templates mode="sanitize" select="*|text()"/></xsl:template>
        <xsl:template match="*[name()='svg']|*[name()='math']"><xsl:apply-templates mode="sanitize" select="."/></xsl:template>
        <xsl:template mode="sanitize" match="*[count(text())=1 and count(*)=0]"><xsl:copy><xsl:apply-templates mode="sanitize" select="@*"/><xsl:value-of select="text()"/></xsl:copy></xsl:template>
        <xsl:template mode="sanitize" match="xhtml:*[count(text())=1 and count(*)=0]"><xsl:element name="{local-name()}"><xsl:apply-templates mode="sanitize" select="@*"/><xsl:value-of select="text()"/></xsl:element></xsl:template>
        <xsl:template mode="sanitize" match="*|@*"><xsl:copy><xsl:apply-templates mode="sanitize" select="*|@*|text()"/></xsl:copy></xsl:template>
        <xsl:template mode="sanitize" match="text()[normalize-space(.) = '']"/>
        <xsl:template mode="sanitize" match="text()"><dce-text><xsl:copy/></dce-text></xsl:template>
        <xsl:template mode="sanitize" match="xsl:value-of|*[name()='slot']"><dce-text><xsl:copy><xsl:apply-templates mode="sanitize" select="*|@*|text()"/></xsl:copy></dce-text></xsl:template>
        <xsl:template mode="sanitize" match="xhtml:*"><xsl:element name="{local-name()}"><xsl:apply-templates mode="sanitize" select="*|@*|text()"/></xsl:element></xsl:template>
    </xsl:stylesheet>`),s=new XSLTProcessor,n=(i=>{T(i,"script",h=>h.remove());const x=i.firstElementChild?.content||i.content,g=h=>q(E("<xhtml/>").importNode(h,!0));if(x){const h=z("div");return[...x.childNodes].map(m=>h.append(m.cloneNode(!0))),g(h)}return g(i.documentElement||i.body||i)})(e),o=E(`<xsl:stylesheet version="1.0"
        xmlns:xsl="${v}"
        xmlns:dce="urn:schemas-epa-wg:dce"
        xmlns:exsl="http://exslt.org/common"
        exclude-result-prefixes="exsl"
    >
    <xsl:template mode="payload"  match="attributes"></xsl:template>
    <xsl:template match="/">
        <xsl:apply-templates mode="payload" select="/datadom/attributes"/>
    </xsl:template>
    <xsl:template name="slot" >
        <xsl:param name="slotname" />
        <xsl:param name="defaultvalue" />
        <xsl:choose>
            <xsl:when test="//payload/*[@slot=$slotname]">
               <xsl:copy-of select="//payload/*[@slot=$slotname]"/>
            </xsl:when>
            <xsl:otherwise>
                <xsl:copy-of select="$defaultvalue"/>
            </xsl:otherwise>
        </xsl:choose>
    </xsl:template>
    <xsl:variable name="js-injected-body">
        <xsl:call-template name="slot" >
            <xsl:with-param name="slotname" select="''"/>
            <xsl:with-param name="defaultvalue"/>
        </xsl:call-template>
    </xsl:variable>
</xsl:stylesheet>`);s.importStylesheet(t);const p=s.transformToFragment(n,document),a=(i,x)=>i.querySelector(x),r=a(o,'template[mode="payload"]');if(!p)return console.error("transformation error",{xml:n.outerHTML,xsl:w(t)});for(const i of p.childNodes)r.append(o.importNode(i,!0));[...r.querySelectorAll("template")].forEach(i=>r.ownerDocument.documentElement.append(i));const N=a(o,'call-template[name="slot"]'),b=i=>{const x=N.cloneNode(!0),g=f(i,"name")||"";g&&x.firstElementChild.setAttribute("select",`'${g}'`);for(let h of i.childNodes)x.lastElementChild.append(h);return x};return T(r,"slot",i=>i.parentNode.replaceChild(b(i),i)),tagUid(o)}export async function xhrTemplate(e){return await new Promise((t,s)=>{const n=new XMLHttpRequest;n.open("GET",e),n.responseType="document",n.onload=()=>{n.readyState===n.DONE&&n.status===200&&t(n.responseXML||z("div",n.responseText)),s(n.statusText)},n.addEventListener("error",o=>s(o)),n.send()})}export function deepEqual(e,l,t=!1){if(e===l)return!0;if(typeof e!="object"||e===null||typeof l!="object"||l===null||Object.keys(e).length!==Object.keys(l).length)return t;for(let s in e)if(!(s in l)||!deepEqual(e[s],l[s]))return t;return!0}export function injectSlice(e,l,t){const o=typeof t=="string"?((p,a="")=>(r=>(r.append(L(e,a||"")),r))(e.ownerDocument.createElement(p)))(l,t):document.adoptNode(E(Json2Xml(t,l)).documentElement);[...e.children].filter(p=>p.localName===l).map(p=>p.remove()),o.data=t,e.append(o)}function T(e,l,t){e.querySelectorAll&&[...e.querySelectorAll(l)].forEach(t)}const X=(e,l)=>(t=>e===t?null:t&&(t.querySelector(l)||X(t,l)))(e.getRootNode()),M=async(e,l)=>{if(!e||!e.trim())return[l];if(e.startsWith("#"))return(t=>{if(!t)return[];const s=t.querySelectorAll(e);if(s.length)return[...s];const n=t.getRootNode();return n===t?[]:X(n)})(l.parentElement);try{const t=await xhrTemplate(e),s=new URL(e,location).hash;if(s){const n=t.querySelectorAll(s);return n.length?[...n]:[l]}return[t]}catch{return[l]}};export function mergeAttr(e,l){if(S(e)){if(!S(l))debugger;return}for(let t of e.attributes)t.namespaceURI?l.setAttributeNS(t.namespaceURI,t.name,t.value):l.setAttribute(t.name,t.value)}export function assureUnique(e,l=0){const t={};for(const s of e.childNodes){const n=f(s,"data-dce-id")||s.dceId||0;if(!t[n])n?t[n]=1:(t[n]=s.dceId=++l,s.setAttribute&&s.setAttribute("data-dce-id",s.dceId));else{const o=s.dceId=n+"-"+t[n]++;s.setAttribute&&s.setAttribute("data-dce-id",o)}s.childNodes.length&&assureUnique(s)}}export function merge(e,l){const t={};for(let s of e.childNodes)t[s.dceId],S(s)?(s.data.trim(),t[s.dceId||0]=s):t[f(s,"data-dce-id")||0]=s;for(let s of[...l]){const n=t[f(s,"data-dce-id")||s.dceId];n?S(s)?n.nodeValue!==s.nodeValue&&(n.nodeValue=s.nodeValue):(mergeAttr(n,s),(n.childNodes.length||s.childNodes.length)&&merge(n,s.childNodes)):e.append(s)}}export class CustomElement extends HTMLElement{async connectedCallback(){const l=await M(f(this,"src"),this),t=l.map(r=>createXsltFromDom(r)),s=t.map((r,c)=>(c=new XSLTProcessor,c.importStylesheet(r),c));Object.defineProperty(this,"xsltString",{get:()=>t.map(r=>w(r)).join(`
`)});const n=f(this,"tag"),o=this,p=[...this.templateNode.querySelectorAll("[slice]")].map(r=>f(r,"slice"));class a extends HTMLElement{connectedCallback(){const c=E("<datadom/>").documentElement,N=(m,u="")=>(y=>(u&&y.append(L(c,u)),y))(c.ownerDocument.createElement(m));A(c,"payload",this.childNodes,U),this.innerHTML="",A(c,"attributes",this.attributes,m=>N(m.nodeName,m.value)),A(c,"dataset",Object.keys(this.dataset),m=>N(m,this.dataset[m]));const b=A(c,"slice",p,m=>N(m,""));this.xml=c;const i=[],x=()=>{const m={};for(let u;u=i.pop();){const y=f(u.target,"slice");m[y]||(injectSlice(b,y,typeof u.detail=="object"?{...u.detail}:u.detail),m[y]=u)}Object.keys(m).length!==0&&h()};let g;this.onSlice=m=>{m.stopPropagation?.();const u=f(m.target,"slice");deepEqual(m.detail,[...b.children].find(y=>y.localName===u)?.data)||(i.push(m),g||(g=setTimeout(()=>{x(),g=0},10)))};const h=()=>{s.map((d,I)=>{const j=d.transformToFragment(c,document);return j||console.error(`XSLT transformation error. xsl:
`,w(t[I]),`
xml:
`,w(c)),j}).map(d=>{d&&(assureUnique(d),merge(this,d.childNodes))});const u=d=>this.onSlice({detail:d[f(d,"slice-prop")||"value"],target:d}),y=d=>d.hasAttribute("slice-prop")||d.hasAttribute("value")||d.value;T(this,"[slice]",d=>{d.dceInitialized||(d.dceInitialized=1,d.addEventListener(f(d,"slice-update")||"change",()=>u(d)),y(d)&&u(d))})};h(),x()}get dce(){return o}}if(n)window.customElements.define(n,a);else{const r="dce-"+crypto.randomUUID();window.customElements.define(r,a);const c=document.createElement(r);this.getAttributeNames().forEach(N=>c.setAttribute(N,this.getAttribute(N))),c.append(...this.childNodes),this.append(c)}}get templateNode(){return this.firstElementChild?.tagName==="TEMPLATE"?this.firstElementChild.content:this}get dce(){return this}get xslt(){return E(this.xsltString)}}window.customElements.define("custom-element",CustomElement);export default CustomElement;
//# sourceMappingURL=custom-element.js.map
