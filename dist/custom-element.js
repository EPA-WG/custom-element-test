const z="http://www.w3.org/1999/XSL/Transform",w="http://www.w3.org/1999/xhtml",I="http://exslt.org/common",U="urn:schemas-epa-wg:dce",b=(e,s)=>e.getAttribute?.(s),T=e=>e.nodeType===3,v=(e,s="",t=document)=>(l=>(l.innerText=s||"",l))((t.ownerDocument||t).createElement(e)),A=(e,s)=>(e.ownerDocument||e).createTextNode(s),L=e=>{for(;e.firstChild;)e.firstChild.remove();return e},H=(e,s,t="")=>(l=>(l.innerText=t||"",l))(document.createElementNS(e,s)),X=e=>(e?.setAttribute("xmlns:xsl",z),e),q=e=>(e?.setAttribute("xmlns:xhtml",w),X(e));function _(e){}export function xml2dom(e){return new DOMParser().parseFromString(e,"application/xml")}export function xmlString(e){return new XMLSerializer().serializeToString(e)}function C(e,s,t,l){const n=m=>e.ownerDocument.createElement(m),u=((m,f,d)=>(f.append(d=n(m)),d))(s,e);return[...t].forEach(m=>u.append(l(m))),u}function M(e){return e.slot||(e.setAttribute||(e=v("span",e.textContent.replaceAll(`
`,""))),e.setAttribute("slot","")),e}export function Json2Xml(e,s){if(typeof e=="string")return e;const t=typeof s!="string";if(e instanceof Array)return t&&(s="array"),"<"+s+">"+e.map(function(r){return Json2Xml(r,s)}).join()+"</"+s+">";t&&(s="r"),s=s.replace(/[^a-z0-9\-]/gi,"_");var l={},n=["<"+s+" "];for(let r in e)typeof e[r]=="object"?l[r]=e[r]:n.push(r.replace(/[^a-z0-9\-]/gi,"_")+'="'+e[r].toString().replace(/&/gi,"&#38;")+'"');if(l){n.push(">");for(let r in l)n.push(Json2Xml(l[r],r));n.push("</"+s+">")}else n.push("/>");return n.join(`
`)}export function tagUid(e){if(S(e,"*",s=>[...s.childNodes].filter(t=>t.nodeType===3).forEach(t=>{if(t.parentNode.localName==="style")return;const l=t.data.matchAll(/{([^}]*)}/g);if(l){let n=0,r=m=>A(t,m||""),u=[];if([...l].forEach(m=>{m.index>n&&u.push(r(m.input.substring(n,m.index)));const f=e.querySelector("value-of").cloneNode();f.setAttribute("select",m[1]),u.push(f),n=m.index+m[0].length}),n<t.data.length&&u.push(r(t.data.substring(n,t.data.length))),u.length){for(let m of u)s.insertBefore(m,t);s.removeChild(t)}}})),"all"in e){let s=1;for(let t of e.all)t.setAttribute&&!t.tagName.startsWith("xsl:")&&t.setAttribute("data-dce-id",""+s++)}return e}export function createXsltFromDom(e,s="xsl:stylesheet"){if(e.tagName===s||e.documentElement?.tagName===s)return tagUid(e);const t=xml2dom(`<xsl:stylesheet version="1.0" xmlns:xsl="${z}" xmlns:xhtml="${w}" xmlns:exsl="${I}" exclude-result-prefixes="exsl" >   
        <xsl:output method="xml" />
        <xsl:template match="/"><dce-root xmlns="${w}"><xsl:apply-templates select="*"/></dce-root></xsl:template>
        <xsl:template match="*[name()='template']"><xsl:apply-templates mode="sanitize" select="*|text()"/></xsl:template>
        <xsl:template match="*"><xsl:apply-templates mode="sanitize" select="*|text()"/></xsl:template>
        <xsl:template match="*[name()='svg']|*[name()='math']"><xsl:apply-templates mode="sanitize" select="."/></xsl:template>
        <xsl:template mode="sanitize" match="*[count(text())=1 and count(*)=0]"><xsl:copy><xsl:apply-templates mode="sanitize" select="@*"/><xsl:value-of select="text()"/></xsl:copy></xsl:template>
        <xsl:template mode="sanitize" match="xhtml:*[count(text())=1 and count(*)=0]"><xsl:element name="{local-name()}"><xsl:apply-templates mode="sanitize" select="@*"/><xsl:value-of select="text()"/></xsl:element></xsl:template>
        <xsl:template mode="sanitize" match="*|@*"><xsl:copy><xsl:apply-templates mode="sanitize" select="*|@*|text()"/></xsl:copy></xsl:template>
        <xsl:template mode="sanitize" match="text()[normalize-space(.) = '']"/>
        <xsl:template mode="sanitize" match="text()"><dce-text><xsl:copy/></dce-text></xsl:template>
        <xsl:template mode="sanitize" match="xsl:value-of|*[name()='slot']"><dce-text><xsl:copy><xsl:apply-templates mode="sanitize" select="*|@*|text()"/></xsl:copy></dce-text></xsl:template>
        <xsl:template mode="sanitize" match="xhtml:*"><xsl:element name="{local-name()}"><xsl:apply-templates mode="sanitize" select="*|@*|text()"/></xsl:element></xsl:template>
    </xsl:stylesheet>`),l=new XSLTProcessor,n=(a=>{S(a,"script",o=>o.remove());const x=a.firstElementChild?.content||a.content,y=o=>{const c=xml2dom("<xhtml/>"),g=c.importNode(o,!0);return c.replaceChild(g,c.documentElement),q(g)};if(x){const o=v("div");return[...x.childNodes].map(c=>o.append(c.cloneNode(!0))),y(o)}return y(a.documentElement||a.body||a)})(e),r=xml2dom(`<xsl:stylesheet version="1.0"
        xmlns:xsl="${z}"
        xmlns:xhtml="${w}"
        xmlns:dce="urn:schemas-epa-wg:dce"
        xmlns:exsl="http://exslt.org/common"
        exclude-result-prefixes="exsl"
    >
    <xsl:template match="ignore">
        <xsl:choose>
            <xsl:when test="//attr">{//attr}</xsl:when>
            <xsl:otherwise>{def}</xsl:otherwise>
        </xsl:choose>
        <xsl:value-of select="."/></xsl:template>
    <xsl:template mode="payload"  match="attributes"></xsl:template>
    <xsl:template match="/">
        <xsl:apply-templates mode="payload" select="/datadom/attributes"/>
    </xsl:template>
    <xsl:template name="slot" >
        <xsl:param name="slotname" />
        <xsl:param name="defaultvalue" />
        <xsl:choose>
            <xsl:when test="//payload/*[@slot=$slotname]">
               <xsl:copy-of select="//payload/*[@slot=$slotname]"/>
            </xsl:when>
            <xsl:otherwise>
                <xsl:copy-of select="$defaultvalue"/>
            </xsl:otherwise>
        </xsl:choose>
    </xsl:template>
    <xsl:variable name="js-injected-body">
        <xsl:call-template name="slot" >
            <xsl:with-param name="slotname" select="''"/>
            <xsl:with-param name="defaultvalue"/>
        </xsl:call-template>
    </xsl:variable>
</xsl:stylesheet>`);l.importStylesheet(t);const u=l.transformToFragment(n,document),m=(a,x)=>a.querySelector(x),f=m(r,'template[mode="payload"]');if(!u)return console.error("transformation error",{xml:n.outerHTML,xsl:xmlString(t)});const d=[];[...u.querySelectorAll("dce-root>param")].forEach(a=>{f.append(a);let x=b(a,"select")?.split("??");if(x||(x=["//"+b(a,"name"),`'${a.textContent}'`],L(a)),x?.length>1){a.removeAttribute("select");const y=m(r,'template[match="ignore"]>choose').cloneNode(!0);y.firstElementChild.setAttribute("test",x[0]),L(y.firstElementChild).append(A(y,"{"+x[0]+"}")),L(y.lastElementChild).append(A(y,"{"+x[1]+"}")),a.append(y)}d.push(a)});for(const a of u.childNodes)f.append(r.importNode(a,!0));[...f.querySelectorAll("template")].forEach(a=>f.ownerDocument.documentElement.append(a));const h=m(r,'call-template[name="slot"]'),E=a=>{const x=h.cloneNode(!0),y=b(a,"name")||"";y&&x.firstElementChild.setAttribute("select",`'${y}'`);for(let o of a.childNodes)x.lastElementChild.append(o);return x};S(f,"slot",a=>a.parentNode.replaceChild(E(a),a));const N=tagUid(r);return N.params=d,N}export async function xhrTemplate(e){return await new Promise((t,l)=>{const n=new XMLHttpRequest;n.open("GET",e),n.responseType="document",n.onload=()=>{n.readyState===n.DONE&&n.status===200&&t(n.responseXML||v("div",n.responseText)),l(n.statusText)},n.addEventListener("error",r=>l(r)),n.send()})}export function deepEqual(e,s,t=!1){if(e===s)return!0;if(typeof e!="object"||e===null||typeof s!="object"||s===null||Object.keys(e).length!==Object.keys(s).length)return t;for(let l in e)if(!(l in s)||!deepEqual(e[l],s[l]))return t;return!0}export function injectSlice(e,s,t){const r=typeof t=="string"?((u,m="")=>(f=>(f.append(A(e,m||"")),f))(e.ownerDocument.createElement(u)))(s,t):document.adoptNode(xml2dom(Json2Xml(t,s)).documentElement);[...e.children].filter(u=>u.localName===s).map(u=>u.remove()),r.data=t,e.append(r)}function S(e,s,t){e.querySelectorAll&&[...e.querySelectorAll(s)].forEach(t)}const j=(e,s)=>(t=>e===t?null:t&&(t.querySelector(s)||j(t,s)))(e.getRootNode()),R=async(e,s)=>{if(!e||!e.trim())return[s];if(e.startsWith("#"))return(t=>{if(!t)return[];const l=t.querySelectorAll(e);if(l.length)return[...l];const n=t.getRootNode();return n===t?[]:j(n)})(s.parentElement);try{const t=await xhrTemplate(e),l=new URL(e,location).hash;if(l){const n=t.querySelectorAll(l);return n.length?[...n]:[s]}return[t]}catch{return[s]}};export function mergeAttr(e,s){if(T(e)){if(!T(s))debugger;return}for(let t of e.attributes)t.namespaceURI?s.setAttributeNS(t.namespaceURI,t.name,t.value):s.setAttribute(t.name,t.value)}export function assureUnique(e,s=0){const t={};for(const l of e.childNodes){const n=b(l,"data-dce-id")||l.dceId||0;if(!t[n])n?t[n]=1:(t[n]=l.dceId=++s,l.setAttribute&&l.setAttribute("data-dce-id",l.dceId));else{const r=l.dceId=n+"-"+t[n]++;l.setAttribute&&l.setAttribute("data-dce-id",r)}l.childNodes.length&&assureUnique(l)}}export function merge(e,s){const t={};for(let l of e.childNodes)t[l.dceId],T(l)?(l.data.trim(),t[l.dceId||0]=l):t[b(l,"data-dce-id")||0]=l;for(let l of[...s]){const n=t[b(l,"data-dce-id")||l.dceId];n?T(l)?n.nodeValue!==l.nodeValue&&(n.nodeValue=l.nodeValue):(mergeAttr(n,l),(n.childNodes.length||l.childNodes.length)&&merge(n,l.childNodes)):e.append(l)}}export function assureUID(e,s){return e.hasAttribute(s)||e.setAttribute(s,crypto.randomUUID()),e.getAttribute(s)}export class CustomElement extends HTMLElement{async connectedCallback(){const s=await R(b(this,"src"),this),t=b(this,"tag"),l=t||"dce-"+crypto.randomUUID();for(const d of s)S(d.templateNode||d.content||d,"style",i=>{const h=i.closest("slot"),E=h?`slot[name="${h.name}"]`:"";i.innerHTML=`${l} ${E}{${i.innerHTML}}`,this.append(i)});const n=s.map(d=>createXsltFromDom(d)),r=n.map((d,i)=>(i=new XSLTProcessor,i.importStylesheet(d),i));Object.defineProperty(this,"xsltString",{get:()=>n.map(d=>xmlString(d)).join(`
`)});const u=this,m=[...this.templateNode.querySelectorAll("[slice]")].map(d=>b(d,"slice"));class f extends HTMLElement{static get observedAttributes(){return n.reduce((i,h)=>(h.params&&i.push(...h.params.map(E=>b(E,"name"))),i),[])}connectedCallback(){if(this.firstElementChild?.tagName==="TEMPLATE"){const o=this.firstElementChild;for(const c of[...o.content.childNodes])if(c.localName==="style"){const g=assureUID(this,"data-dce-style");c.innerHTML=`${l}[data-dce-style="${g}"]{${c.innerHTML}}`,o.insertAdjacentElement("beforebegin",c)}else c.nodeType===1?o.insertAdjacentElement("beforebegin",c):c.nodeType===3&&o.insertAdjacentText("beforebegin",c.data);o.remove()}const i=xml2dom("<datadom/>").documentElement,h=(o,c="")=>(g=>(c&&g.append(A(i,c)),g))(i.ownerDocument.createElement(o));C(i,"payload",this.childNodes,M),this.innerHTML="",C(i,"attributes",this.attributes,o=>h(o.nodeName,o.value)),C(i,"dataset",Object.keys(this.dataset),o=>h(o,this.dataset[o]));const E=C(i,"slice",m,o=>h(o,""));this.xml=i;const N=[],a=()=>{const o={};for(let c;c=N.pop();){const g=b(c.target,"slice");o[g]||(injectSlice(E,g,typeof c.detail=="object"?{...c.detail}:c.detail),o[g]=c)}Object.keys(o).length!==0&&y()};let x;this.onSlice=o=>{o.stopPropagation?.();const c=b(o.target,"slice");deepEqual(o.detail,[...E.children].find(g=>g.localName===c)?.data)||(N.push(o),x||(x=setTimeout(()=>{a(),x=0},10)))};const y=this.transform=()=>{r.map((p,D)=>{const $=p.transformToFragment(i.ownerDocument,document);return $||console.error(`XSLT transformation error. xsl:
`,xmlString(n[D]),`
xml:
`,xmlString(i)),$}).map(p=>{p&&(assureUnique(p),merge(this,p.childNodes))});const c=p=>this.onSlice({detail:p[b(p,"slice-prop")||"value"],target:p}),g=p=>p.hasAttribute("slice-prop")||p.hasAttribute("value")||p.value;S(this,"[slice]",p=>{p.dceInitialized||(p.dceInitialized=1,p.addEventListener(b(p,"slice-update")||"change",()=>c(p)),g(p)&&c(p))})};y(),a()}attributeChangedCallback(i,h,E){if(!this.xml)return;let N=this.xml.querySelector(`attributes>${i}`);N?L(N).append(A(N,E)):(N=v(i,E,this.xml),N.append(A(N,E)),this.xml.querySelector("attributes").append(N)),this.transform()}get dce(){return u}}if(t)window.customElements.define(t,f);else{const d=l;window.customElements.define(d,f);const i=document.createElement(d);this.getAttributeNames().forEach(h=>i.setAttribute(h,this.getAttribute(h))),i.append(...[...this.childNodes].filter(h=>h.localName!=="style")),this.append(i)}}get templateNode(){return this.firstElementChild?.tagName==="TEMPLATE"?this.firstElementChild.content:this}get dce(){return this}get xslt(){return xml2dom(this.xsltString)}}window.customElements.define("custom-element",CustomElement);export default CustomElement;
//# sourceMappingURL=custom-element.js.map
